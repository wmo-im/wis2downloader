name: Unit Tests ⚙️

on: [push, pull_request]

permissions:
  contents: read
  packages: write
  issues: write
  pull-requests: write

jobs:
  main:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        name: Setup Python ${{ matrix.python-version }}
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create config file
        run: "\n
          echo '{
            \"base_url\": \"http://localhost:5050\",\n
            \"broker_hostname\": \"globalbroker.meteo.fr\",\n
            \"broker_password\": \"everyone\",\n
            \"broker_port\": 443,\n
            \"broker_protocol\": \"websockets\",\n
            \"broker_username\": \"everyone\",\n
            \"download_workers\": 1,\n
            \"download_dir\": \"downloads\",\n
            \"flask_host\": \"0.0.0.0\",\n
            \"flask_port\": 5050,\n
            \"log_level\": \"DEBUG\",\n
            \"log_path\": \"logs\",\n
            \"min_free_space\": 10,\n
            \"mqtt_session_info\" : \"mqtt_session.json\",\n
            \"save_logs\": false,\n
            \"validate_topics\": true\n
          }' > config.json"
        shell: bash

      - name: Set config environment variable
        run: |
          CONFIG_PATH="$PWD/config.json"
          echo "WIS2DOWNLOADER_CONFIG=$CONFIG_PATH" >> $GITHUB_ENV

      - name: Install requirements 📦
        run: |
          python3 -m pip install --upgrade pip
          pip3 install .
          pip3 install -r requirements-dev.txt
      - name: run tests ⚙️
        run: |
          pytest

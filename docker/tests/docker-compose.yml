services:
  broker:
    build:
      context: ./containers/broker/
      dockerfile: Dockerfile
    container_name: broker
    ports:
      - "1883:1883"
    healthcheck:
      test: [ "CMD", "mosquitto_sub -t '$$SYS/#' -C 1 | grep -v Error || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  publisher:
      build:
        context: ./containers/publisher/
        dockerfile: Dockerfile
      container_name: publisher
      depends_on:
        - broker
        - subscriber
      tty: true
      volumes:
        - ./data:/data

  subscriber:
      build:
        context: ./../
        dockerfile: Dockerfile
      container_name: subscriber
      environment:
        DOWNLOAD_BROKER_HOST: "broker"
        DOWNLOAD_BROKER_PORT: 1883
        DOWNLOAD_BROKER_TRANSPORT: "tcp"
        DOWNLOAD_DIR: "/data/downloads"
      ports:
        - "5000:5000"
      volumes:
        - ./data:/data
      depends_on:
        - broker
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:5000/health" ]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 10s